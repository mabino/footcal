<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ICS Calendar</title>
  <link href="/fullcalendar/main.min.css" rel="stylesheet">
  <script src="/fullcalendar/main.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    #calendar { max-width: 900px; margin: auto; }
  </style>
</head>
<body>
  <h2>Calendar</h2>
  <div id="legend" style="max-width: 900px; margin: auto; padding-bottom: 1em;">
  <strong>Legend:</strong>
</div>
  <div id="calendar"></div>

  <script>
  document.addEventListener('DOMContentLoaded', async function () {
    const res = await fetch('/events');
    const { events, feeds } = await res.json();

    const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
      initialView: 'listWeek',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'timeGridWeek,listWeek'
      },
      events: events,
      eventDidMount: function (info) {
        const source = info.event.extendedProps.source;
        const color = feeds[source]?.color || '#888';
        info.el.style.backgroundColor = color;
        info.el.style.borderColor = color;
      }
    });

    calendar.render();

    // Generate legend
    const legend = document.getElementById('legend');
    const ul = document.createElement('ul');
    ul.style.listStyle = 'none';
    ul.style.paddingLeft = '0';

    for (const [id, meta] of Object.entries(feeds)) {
      const li = document.createElement('li');
      li.innerHTML = `<span style="display:inline-block;width:12px;height:12px;background:${meta.color};margin-right:8px;"></span>${meta.name}`;
      ul.appendChild(li);
    }

    legend.appendChild(ul);
  });  </script>
</body>
</html>
